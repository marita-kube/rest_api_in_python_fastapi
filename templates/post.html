{% extends "layout.html" %}
{% block content %}

        <article class="content-section py-3 px-4 mb-4">
            <div class="d-flex align-items-start gap-4">
                <img class = "rounded-circle article-img flex-shrink-0"
                    src="{{ post.author.image_path }}"
                    alt="{{ post.author.username }}'s photo "
                    width="64"
                    height="64"
                    loading="lazy">
                <div class="flex-grow-1">
                    <div class="article-metadata mb-2">
                        <a class="me-2" href="{{ url_for('users_posts_items', user_id=post.author.id )}}">{{ post.author.username }}</a>
                        <small class="text-body-secondary">{{ post.date_posted.strftime("%B %d, %Y")}}</small>
                    </div>
                    <h3>
                        <a class="article-title" href="#">{{ post.title }}</a>
                    </h3>
                    <p class="article-content"> {{ post.content }}</p>

                    <!--Edit Post -->

                    {% if post.user_id == 1 %}
                        <div class="post-actions mt-3 pt-3 border-top">
                            <button type="button"
                                class="btn btn-outline-secondary me-1"
                                data-bs-toggle="modal"
                                data-bs-target="#editModal">Edit Post</button>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                                data-bs-target="#deletemodal">Delete Post</button>
                        </div>
                    {% endif %}   

                </div>
                <!-- User authentication comes here!-->
                </div>
            </div>
        </article>
        <!--Edit Modal Post-->
        <div class="modal fade"
            id="editModal"
            tabindex="-1"
            aria-labelledby="editModalLabel"
            aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Post</h5>
                    <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close">
                    </button>
            </div>
            <form id="editPostForm">
                <div class="modal-body">
                    <input type="hidden" name="post_id" value="{{ post.id}}">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Title</label>
                        <input type="text"
                            class="form-control"
                            id="editTitle"
                            name="title"
                            value="{{ post.title}}"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">Content</label>
                        <textarea class="form-control"
                            id="editContent"
                            name="content"
                            rows="5" required>{{ post.content}}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button"
                        class="btn btn-outline-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
            </div>
        </div>
        </div>
        <!-- Delete Modal-->
        <div class="modal fade"
            id="deletemodal"
            tabindex="-1"
            aria-labelledby="deleteModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel">Delete Post?</h5>
                        <button type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="fs-5">Dele this post permanently?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                    </div>
                </div>
            </div>
        </div>
{% block scripts %}
        <script type="module">
            import {
                getErorMessage,
                hideModal,
                showModal,
            } from "/static/js/utils.js";
            //get post id from jinja2 template
            const postId = {{ post.id }};

            //Form handler for edit post
            const editForm = document.getElementById("editPostForm");
            editForm.addEventListener("submit", async(event) =>{
                event.preventDefault();

                //gather form values

                const formData = new FormData(editForm);
                const postData = Object.fromEntries(formData.entries());

                //remove post_id from the data
                delete postData.post_id;

                try {
                    //update content or title
                    const res = await fetch(`/api/posts/${postId}`,{
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",

                        },
                        body: JSON.stringify(postData),
                    });

                    if (res.ok){
                        document.getElementById("successMessage").textContent = "Update success!";

                        hideModal("editModal");
                        showModal("successModal");

                        document
                                .getElementById("successModal")
                                .addEventListener("hidden.bs.modal", () => { window.location.reload();

                                },
                                { once: true },
                            );


                    } else {
                        const error = await res.json();
                        document.getElementById("errorMessage").textContent = getErorMessage(error);

                        hideModal("editModal");
                        showModal("errorModal");
                    }
                } catch (error){
                    document.getElementById("errorMessage").textContent="Network error. Try again!";
                    showModal("errorModal");
                }
            });
            const deleteButton = document.getElementById("confirmDelete");
            deleteButton.addEventListener("click", async () => {
                try {
                    const res = await fetch(`/api/posts/${postId}`, {
                        method: "DELETE",
                    });

                    if (res.status == 204){
                        window.location.href = "/";
                    }else{
                        const error = await res.json();
                        document.getElementById("errorMessage").textContent=getErorMessage(error);

                        hideModal("deleteModal");
                        showModal("errorModal");
                    }
                } catch (error){
                    document.getElementById("errorMessage").textContent="Network error. Try again!";
                    showModal("errorModal");
                }
            });


        </script>
    {% endblock scripts %}

{% endblock content %}